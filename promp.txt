Est√°s por generar el backend de un m√≥dulo de autenticaci√≥n profesional y seguro.

Se te entrega un archivo YAML llamado req.back.v3.2.mini.yml que define el contrato t√©cnico y funcional del m√≥dulo: endpoints, modelos de datos, seguridad, y reglas de negocio.
Tu tarea es leer el YAML completo y cumplirlo exactamente, sin agregar nada que no est√© all√≠.
El objetivo es obtener un MVP funcional, limpio, y extremadamente legible.

üß© Reglas absolutas

C√≥digo lo m√°s simple y legible posible.
Prioridad 1: claridad. No escribir c√≥digo ‚Äúclever‚Äù.

Todas las variables deben tener nombres significativos.

No usar ORM.
Usar consultas SQL directas con psycopg (psycopg3).
Mantener cada consulta en una funci√≥n clara, con try/except manejado con precisi√≥n.

No agregar endpoints ni l√≥gica no especificada en el YAML.

Solo hacer lo funcional del YAML (MVP).
Nada de tests, m√©tricas, logs, middlewares de tracing, ni extras.

Estructura de carpetas obligatoria (patr√≥n m√≠nimo):
api/
  ‚îú‚îÄ‚îÄ auth.py      # todas las rutas /auth/*
  ‚îî‚îÄ‚îÄ jwks.py      # ruta /.well-known/jwks.json

service/
  ‚îî‚îÄ‚îÄ auth.py      # l√≥gica de negocio del m√≥dulo

models/
  ‚îú‚îÄ‚îÄ user.py
  ‚îú‚îÄ‚îÄ refresh_token.py
  ‚îî‚îÄ‚îÄ types.py     # claims, enums, estructuras auxiliares

db/
  ‚îî‚îÄ‚îÄ auth.py      # consultas SQL directas

utils/
  ‚îú‚îÄ‚îÄ crypto.py    # firma/verificaci√≥n JWS y cifrado JWE
  ‚îú‚îÄ‚îÄ jwks.py      # carga y cacheo de claves
  ‚îú‚îÄ‚îÄ tokens.py    # helpers de generaci√≥n/rotaci√≥n
  ‚îî‚îÄ‚îÄ security.py  # validaciones y pol√≠ticas

main.py            # punto de entrada FastAPI

- Detalles t√©cnicos obligatorios

Framework: FastAPI (Python 3.11+)

Autenticaci√≥n: JWT con firma JWS (RS256/ES256) y cifrado JWE anidado (‚Äúnested‚Äù).

Refresh tokens: opacos (hash SHA256) con rotaci√≥n obligatoria.

Endpoint /auth/token/refresh debe revocar el token usado y emitir uno nuevo.

Exponer JWKS p√∫blico en /.well-known/jwks.json con claves sig, enc, enc_front.

Implementar front-side encryption opcional: si llega un campo __front_enc__, descifrarlo antes de procesar el cuerpo.

Usar bcrypt para hash de contrase√±as.

No almacenar refresh tokens en texto claro, solo el hash.

Cumplir las pol√≠ticas de validaci√≥n y errores descriptos en el YAML.

Todas las respuestas deben seguir la forma:
{ "error": { "code": "AUTH_INVALID_CREDENTIALS", "message": "..." } }


Objetivo del c√≥digo final

Un m√≥dulo autocontenido y funcional, que permita:

Registrar usuarios (/auth/register)

Iniciar sesi√≥n (/auth/login)

Refrescar tokens (/auth/token/refresh)

Cerrar sesi√≥n (/auth/logout)

Exponer claves p√∫blicas (/.well-known/jwks.json)

Todo en menos de ~400 l√≠neas totales, bien organizadas, sin redundancias y sin dependencias innecesarias.

- Requisitos de implementaci√≥n

Cada endpoint debe llamar a su correspondiente funci√≥n de servicio.

Los servicios usan funciones del nivel db/ para acceder a datos.

El c√≥digo debe funcionar ejecutando:
uvicorn main:app --reload

Usar dataclasses o Pydantic solo para I/O y validaci√≥n b√°sica.

Si algo del YAML no est√° completamente definido, dejar un comentario # TODO explicando claramente la parte faltante.

- Estilo general

Usa imports expl√≠citos y cortos.

Comentarios solo donde sean esenciales para la comprensi√≥n.

Evit√° cualquier logging, print o testing innecesario.

Formato limpio, consistente y f√°cil de leer.

En el c√≥digo: claridad antes que optimizaci√≥n.

- Resumen

Tu objetivo: Implementar exactamente lo que el YAML pide.
Tu prioridad: M√°xima legibilidad y m√≠nima complejidad.
Tu resultado: Un backend profesional, autocontenido y listo para correr, basado en FastAPI + PostgreSQL con JWT/JWE.


y lo vas a devolver en un .zip
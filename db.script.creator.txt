-- PostgreSQL DDL (copiar/pegar). Requiere extensiones: pgcrypto, citext.
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS citext;

-- USERS
CREATE TABLE IF NOT EXISTS users (
  id              uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  email           citext UNIQUE NOT NULL,
  password_hash   text NOT NULL,
  email_verified  boolean NOT NULL DEFAULT false,
  created_at      timestamptz NOT NULL DEFAULT now(),
  updated_at      timestamptz NOT NULL DEFAULT now()
);

CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS trigger AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_users_updated_at ON users;
CREATE TRIGGER trg_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- REFRESH TOKENS
CREATE TABLE IF NOT EXISTS refresh_tokens (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id       uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token_hash    bytea NOT NULL,                    -- sha256(raw) como bytea
  issued_at     timestamptz NOT NULL DEFAULT now(),
  expires_at    timestamptz NOT NULL,
  revoked_at    timestamptz NULL,
  parent_id     uuid NULL REFERENCES refresh_tokens(id) ON DELETE SET NULL,
  user_agent    text NULL,
  ip            inet NULL,
  CONSTRAINT uq_refresh_token_hash UNIQUE (token_hash),
  CONSTRAINT chk_expires_in_future CHECK (expires_at > issued_at)
);

CREATE INDEX IF NOT EXISTS idx_refresh_user_id ON refresh_tokens(user_id);
CREATE INDEX IF NOT EXISTS idx_refresh_expires_at ON refresh_tokens(expires_at);
CREATE INDEX IF NOT EXISTS idx_refresh_parent_id ON refresh_tokens(parent_id);
CREATE INDEX IF NOT EXISTS idx_refresh_revoked_at ON refresh_tokens(revoked_at);

-- (Opcional) LOG DE AUDITOR√çA
CREATE TABLE IF NOT EXISTS auth_audit_log (
  id         bigserial PRIMARY KEY,
  event      text NOT NULL,               -- auth.login.success|failure, token.refresh.success|reuse_detected, auth.logout
  user_id    uuid NULL REFERENCES users(id) ON DELETE SET NULL,
  jti        text NULL,                   -- jti del access (si aplica)
  refresh_id uuid NULL REFERENCES refresh_tokens(id) ON DELETE SET NULL,
  ip         inet NULL,
  user_agent text NULL,
  created_at timestamptz NOT NULL DEFAULT now()
);
